<script setup lang="ts">
// #region Imports
import { onMounted, computed, ref } from "vue";
import { useI18n } from "vue-i18n";
import {
  FormInput,
  FormLabel,
  FormTextarea,
  FormSelect,
  FormErrorMessages,
} from "../../base-components/Form";
import { useUserContextStore } from "../../stores/user-context";
import {
  TitleLayout,
  TwoColumnsLayout,
} from "../../base-components/Form/FormLayout";
import { TwoColumnsLayoutCards } from "../../base-components/Form/FormLayout/TwoColumnsLayout.vue";
import LoadingOverlay from "../../base-components/LoadingOverlay";
import AlertPlaceholder from "../../base-components/AlertPlaceholder";
import { CardState } from "../../types/enums/CardState";
import posSystemImage from "../../assets/images/pos_system.png";
import wareHouseImage from "../../assets/images/warehouse_system.png";
import accountingImage from "../../assets/images/accounting_system.jpg";
import { Check } from "lucide-vue-next";
import Button from "../../base-components/Button";
import { formatDate } from "../../utils/helper";
import ProfileService from "../../services/ProfileService";
// #endregion

// #region Interfaces
interface RoleSelection {
  images: string;
  selectable: boolean,
  rolekey: string;
};
// #endregion

// #region Declarations
const { t } = useI18n();

const profileServices = new ProfileService();
const userContextStore = useUserContextStore();
// #endregion

// #region Props, Emits
// #endregion

// #region Refs
const loading = ref<boolean>(false);
const cards = ref<Array<TwoColumnsLayoutCards>>([
  { title: "User Profile", state: CardState.Expanded },
  { title: "Account Settings", state: CardState.Expanded },
  { title: "Change Password", state: CardState.Expanded },
  { title: "User Setting", state: CardState.Expanded },
  { title: "Roles", state: CardState.Expanded, id: "roles" },
]);

const roleSelection = ref<Array<RoleSelection>>([
  {
    images: posSystemImage,
    selectable: false,
    rolekey: "pos",
  },
  {
    images: wareHouseImage,
    selectable: false,
    rolekey: "wh",
  },
  {
    images: accountingImage,
    selectable: false,
    rolekey: "wh",
  },
]);

const userProfileForm = profileServices.useUserProfileUpdateForm();
// #endregion

// #region Computed
const userContext = computed(() => userContextStore.getUserContext);
// #endregion

// #region Lifecycle Hooks
onMounted(() => {

});
// #endregion

// #region Methods
const handleExpandCard = (index: number) => {
  if (cards.value[index].state === CardState.Collapsed) {
    cards.value[index].state = CardState.Expanded;
  } else if (cards.value[index].state === CardState.Expanded) {
    cards.value[index].state = CardState.Collapsed;
  }
};

const handleChangeRole = (index: number) => {
  let activeRole: string = roleSelection.value[index].rolekey;

  console.log(activeRole);
}

const hasRolePOSOwner = () => {
  let result = false;
  for (const r of userContext.value.roles) {
    if (r.display_name == 'POS-owner') {
      result = true;
    }
  }
  return result;
};

const hasRoleWHOwner = () => {
  let result = false;
  for (const r of userContext.value.roles) {
    if (r.display_name == 'WH-owner') {
      result = true;
    }
  }
  return result;
};

const hasRoleACCOwner = () => {
  let result = false;
  for (const r of userContext.value.roles) {
    if (r.display_name == 'ACC-owner') {
      result = true;
    }
  }
  return result;
};

const checkRoles = () => {
  if (!hasRolePOSOwner()) { roleSelection.value[0].selectable = true; }
  if (!hasRoleWHOwner()) { roleSelection.value[1].selectable = true; }
  if (!hasRoleACCOwner()) { roleSelection.value[2].selectable = true; }
}

const onSubmit = async () => {
  checkRoles();
};
// #region Methods

// #region Watchers
// #endregion
</script>

<template>
  <div class="mt-8">
    <LoadingOverlay :visible="loading">
      <TitleLayout>
        <template #title>
          {{ t("views.profile.title") }}
        </template>
      </TitleLayout>
      <form id="userProfileForm" @submit.prevent="onSubmit">
        <TwoColumnsLayout :cards="cards" :show-side-tab="true" :using-side-tab="true"
          @handleExpandCard="handleExpandCard">
          <template #side-menu-title>
            {{ userContext.name }}
          </template>
          <template #card-items-0>
            <div class="p-5">
              <div class="pb-4">
                <FormLabel html-for="name" :class="{ 'text-danger': userProfileForm.invalid('name') }">
                  {{ t("views.profile.fields.name") }}
                </FormLabel>
                <FormInput id="name" v-model="userProfileForm.name" name="name" type="text"
                  :class="{ 'w-full': true, 'border-danger': userProfileForm.invalid('name') }"
                  :placeholder="t('views.profile.fields.name')" @change="userProfileForm.validate('name')" />
                <FormErrorMessages :messages="userProfileForm.errors.name" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="email">
                  {{ t("views.profile.fields.email") }}
                </FormLabel>
                <FormInput id="email" v-model="userContext.email" name="email" type="text" class="w-full"
                  :placeholder="t('views.profile.fields.email')" disabled />
              </div>
            </div>
          </template>
          <template #card-items-1>
            <div class="p-5">
              <div class="pb-4">
                <FormLabel html-for="first_name">
                  {{ t("views.profile.fields.first_name") }}
                </FormLabel>
                <FormInput id="first_name" v-model="userProfileForm.first_name" name="first_name" type="text"
                  :placeholder="t('views.profile.fields.first_name')" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="last_name">
                  {{ t("views.profile.fields.last_name") }}
                </FormLabel>
                <FormInput id="last_name" v-model="userProfileForm.last_name" name="last_name" type="text"
                  :placeholder="t('views.profile.fields.last_name')" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="address">
                  {{ t("views.profile.fields.address") }}
                </FormLabel>
                <FormTextarea id="address" v-model="userProfileForm.address" name="address" rows="5"
                  :placeholder="t('views.profile.fields.address')" />
              </div>
              <div class="flex gap-2">
                <div class="pb-4 w-full">
                  <FormLabel html-for="city">
                    {{ t("views.profile.fields.city") }}
                  </FormLabel>
                  <FormInput id="address" v-model="userProfileForm.city" name="city" type="text" class="w-full"
                    :placeholder="t('views.profile.fields.city')" />
                </div>
                <div class="pb-4">
                  <FormLabel html-for="postal_code">
                    {{ t("views.profile.fields.postal_code") }}
                  </FormLabel>
                  <FormInput id="postal_code" v-model="userProfileForm.postal_code" name="postal_code" type="number"
                    class="w-full" :placeholder="t('views.profile.fields.postal_code')" />
                </div>
              </div>
              <div class="pb-4">
                <FormLabel html-for="country">
                  {{ t("views.profile.fields.country") }}
                </FormLabel>
                <FormSelect id="country" v-model="userProfileForm.country" name="country"
                  :class="{ 'w-full': true, 'border-danger': userProfileForm.invalid('country') }"
                  :placeholder="t('views.profile.fields.country')" @change="userProfileForm.validate('country')">
                  <option>Singapore</option>
                  <option>Indonesia</option>
                </FormSelect>
                <FormErrorMessages :messages="userProfileForm.errors.country" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="tax_id" :class="{ 'border-danger': userProfileForm.invalid('tax_id') }">
                  {{ t("views.profile.fields.tax_id") }}
                </FormLabel>
                <FormInput id="tax_id" v-model="userProfileForm.tax_id" name="tax_id" type="text"
                  :class="{ 'w-full': true, 'border-danger': userProfileForm.invalid('tax_id') }"
                  :placeholder="t('views.profile.fields.tax_id')" />
                <FormErrorMessages :messages="userProfileForm.errors.tax_id" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="ic_num" :class="{ 'border-danger': userProfileForm.invalid('ic_num') }">
                  {{ t("views.profile.fields.ic_num") }}
                </FormLabel>
                <FormInput id="ic_num" v-model="userProfileForm.ic_num" name="ic_num" type="text"
                  :class="{ 'w-full': true, 'border-danger': userProfileForm.invalid('ic_num') }"
                  :placeholder="t('views.profile.fields.ic_num')" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="remarks">
                  {{ t("views.profile.fields.remarks") }}
                </FormLabel>
                <FormTextarea id="remarks" v-model="userProfileForm.remarks" name="remarks" class="w-full" rows="5"
                  :placeholder="t('views.profile.fields.remarks')" />
              </div>
            </div>
          </template>
          <template #card-items-2>
            <div class="p-5">
              <div class="pb-4">
                <FormLabel html-for="current_password">
                  {{ t("views.profile.fields.change_password.current_password") }}
                </FormLabel>
                <FormInput id="current_password" v-model="userProfileForm.current_password" name="current_password"
                  type="password" class="w-full"
                  :placeholder="t('views.profile.fields.change_password.current_password')" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="new_password">
                  {{ t("views.profile.fields.change_password.new_password") }}
                </FormLabel>
                <FormInput id="new_password" v-model="userProfileForm.new_password" name="new_password" type="password"
                  class="w-full" :placeholder="t('views.profile.fields.change_password.new_password')" />
              </div>
              <div class="pb-4">
                <FormLabel html-for="new_password_confirmation">
                  {{ t("views.profile.fields.change_password.confirm_password") }}
                </FormLabel>
                <FormInput id="new_password_confirmation" v-model="userProfileForm.new_password_confirmation"
                  name="new_password_confirmation" type="password" class="w-full"
                  :placeholder="t('views.profile.fields.change_password.confirm_password')" />
              </div>
            </div>
          </template>
          <template #card-items-3>
            <div class="p-5">
              <div class="pb-4">
                <FormLabel html-for="themes">
                  {{ t("views.profile.fields.settings.theme") }}
                </FormLabel>
                <FormSelect id="themes" v-model="userProfileForm.theme" name="themes">
                  <option value="side-menu-light-full">Menu Light</option>
                  <option value="side-menu-light-mini">Mini Menu Light</option>
                  <option value="side-menu-dark-full">Menu Dark</option>
                  <option value="side-menu-dark-mini">Mini Menu Dark</option>
                </FormSelect>
              </div>
              <div class="pb-4">
                <FormLabel html-for="date_format">
                  {{ t("views.profile.fields.settings.date_format") }}
                </FormLabel>
                <FormSelect id="date_format" v-model="userProfileForm.date_format" name="date_format">
                  <option value="yyyy_MM_dd">
                    {{ formatDate(new Date().toString(), "YYYY-MM-DD") }}
                  </option>
                  <option value="dd_MMM_yyyy">
                    {{ formatDate(new Date().toString(), "DD-MMM-YYYY") }}
                  </option>
                </FormSelect>
              </div>
              <div class="pb-4">
                <FormLabel html-for="time_format">
                  {{ t("views.profile.fields.settings.time_format") }}
                </FormLabel>
                <FormSelect id="time_format" v-model="userProfileForm.time_format" name="time_format">
                  <option value="hh_mm_ss">
                    {{ formatDate(new Date().toString(), "HH:mm:ss") }}
                  </option>
                  <option value="h_m_A">
                    {{ formatDate(new Date().toString(), "H:m A") }}
                  </option>
                </FormSelect>
              </div>
            </div>
          </template>
          <template #card-items-roles>
            <div class="p-5">
              <div class="pb-4">
                <div class="grid grid-cols-3 gap-2 place-items center">
                  <div v-for="(item, index) in roleSelection" :key="index" class="flex flex-col items-center">
                    <div class="cursor-pointer flex flex-col items-center justify-center"
                      @click="handleChangeRole(index)">
                      <img alt="" :src="item.images" width="100" height="100" />
                      <div v-if="!item.selectable" class="grid grid-cols-1 place-items-center">
                        <Check class="text-success" />
                      </div>
                      <button v-else class="btn btn-sm btn-secondary hover:btn-primary">
                        {{ t("components.buttons.activate") }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>
        </TwoColumnsLayout>
      </form>
    </LoadingOverlay>
  </div>
</template>
